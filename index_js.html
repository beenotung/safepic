<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="UTF-8">
		<title>安全圖 (ANTI-ITPC)</title>
		<meta name="viewport"
			  content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta name="format-detection" content="telephone=no">
		<meta name="msapplication-tap-highlight" content="no">
	</head>
<body>

	<label for="imageLoader">Image Files:</label><br/>
	<input type="file" id="imageLoader" multiple onchange="handleInput()"/>
	<button type="button" onclick="handleInput()">下載</button>
	<br>
	<br>


	<script>
		function handleInput(){
			var e;
			var i;
			var file;
			var es = document.getElementsByTagName('a');
			for (i = es.length - 1; i >= 0; i--) {
				e = es.item(i);
				e.parentElement.removeChild(e);
			}
			es = document.getElementsByTagName('canvas');
			for (i = es.length - 1; i >= 0; i--) {
				e = es.item(i);
				e.parentElement.removeChild(e);
			}
			var files = document.getElementById('imageLoader').files;
			for (i = 0; i < files.length; i++) {
				file = files.item(i);
				handleImage(file)
			}
		}
		function handleImage(file){
			console.log(file);
			var fName = file.name;
			var fExt = fName.split('.').pop();
			fName = fName.replace('.'+fExt, "_clean."+fExt);
			var fType = file.type;
			var reader = new FileReader();
			reader.onload = function(){
				var img = new Image();
				img.onload = function(){
					var link = document.createElement('a');
					var canvas = document.createElement("canvas");
					document.body.appendChild(link);
					document.body.appendChild(canvas);
					var ctx = canvas.getContext('2d');

					canvas.width = img.width;
					canvas.height = img.height;
					ctx.drawImage(img,0,0);
					link.setAttribute('download', fName);

					link.setAttribute('href', window.URL.createObjectURL(dataURItoBlob(canvas.toDataURL(fType))));
					link.click();
					console.log('ready:', fName);
				};
				img.src = reader.result;
			};
			reader.readAsDataURL(file);
		}
		function dataURItoBlob(dataURI) {
			// convert base64/URLEncoded data component to raw binary data held in a string
			var byteString;
			if (dataURI.split(',')[0].indexOf('base64') >= 0)
				byteString = atob(dataURI.split(',')[1]);
			else
				byteString = unescape(dataURI.split(',')[1]);
			// separate out the mime component
			var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
			// write the bytes of the string to a typed array
			var ia = new Uint8Array(byteString.length);
			for (var i = 0; i < byteString.length; i++) {
				ia[i] = byteString.charCodeAt(i);
			}
			return new Blob([ia], {type:mimeString});
		}
	</script>
</body>
</html>
