<html>
	<head>
		<title>Anti itpc</title>
	</head>
<body>
	<label>Image File:</label><br/>
	<input type="file" id="imageLoader" name="imageLoader" multiple/>
	<button type="button" onclick="document.getElementById('link').click()">下載</button>
	<br>
	<br>

	<a id="link" href="#"></a>
	<canvas id="imageCanvas"></canvas>
	<img src="" id="i"></canvas>

</body>
	<script>
		var link, imageLoader, canvas, ctx, fType, fName, fExt;
		link = document.getElementById('link');
		canvas = document.getElementById("imageCanvas");
		ctx = canvas.getContext('2d');
		imageLoader = document.getElementById('imageLoader');
		imageLoader.addEventListener('change', handleImage, false);
		function handleImage(e){
			if (e.target.files.length > 0) {
				Object.values(e.target.files).forEach(function (data) {
					var reader = new FileReader();
					var fileName = data.name;
					var fileExt = fileName.split('.').pop();
					var fileType = data.type;

					fileName = fileName.replace(`.${fileExt}`,`_clean.${fileExt}`);

					reader.onload = function(event){
						var img = new Image();
						img.onload = function(){
							canvas.width = img.width;
							canvas.height = img.height;
							ctx.drawImage(img,0,0);
							link.setAttribute('download', fileName);
							link.setAttribute('href', window.URL.createObjectURL(dataURItoBlob(canvas.toDataURL(fileType))));
							link.click();
						}

						img.src = event.target.result;
					}
					reader.readAsDataURL(data);
				})
			}
		}

		function dataURItoBlob(dataURI) {
			// convert base64/URLEncoded data component to raw binary data held in a string
			var byteString;
			if (dataURI.split(',')[0].indexOf('base64') >= 0)
				byteString = atob(dataURI.split(',')[1]);
			else
				byteString = unescape(dataURI.split(',')[1]);
			// separate out the mime component
			var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
			// write the bytes of the string to a typed array
			var ia = new Uint8Array(byteString.length);
			for (var i = 0; i < byteString.length; i++) {
				ia[i] = byteString.charCodeAt(i);
			}
			return new Blob([ia], {type:mimeString});
		}
	</script>
</html>
